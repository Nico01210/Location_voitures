image: docker:24.0.2

services:
  - docker:24.0.2-dind

stages:
  - build_and_test
  - docker_build_push
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_USER: "$CI_REGISTRY_USER"        # ou ton utilisateur DockerHub
  DOCKER_PASSWORD: "$CI_REGISTRY_PASSWORD"
  DOCKER_COMPOSE_VERSION: "2.21.0"        # version compose CLI

# ----------------------------
# Build et test des microservices
# ----------------------------
service-client-build-test:
  stage: build_and_test
  image: maven:3.9.6-eclipse-temurin-21
  script:
    - echo "Build et test du service client"
    - cd service-client
    - mvn clean test
    - mvn package -DskipTests
  artifacts:
    paths:
      - service-client/target/*.jar
    expire_in: 1 hour

service-reservation-build-test:
  stage: build_and_test
  image: maven:3.9.6-eclipse-temurin-21
  script:
    - echo "Build et test du service reservation"
    - cd service-reservation
    - mvn clean test
    - mvn package -DskipTests
  artifacts:
    paths:
      - service-reservation/target/*.jar
    expire_in: 1 hour

service-vehicules-build-test:
  stage: build_and_test
  image: maven:3.9.6-eclipse-temurin-21
  script:
    - echo "Build et test du service vehicules"
    - cd service-vehicules
    - mvn clean test
    - mvn package -DskipTests
  artifacts:
    paths:
      - service-vehicules/target/*.jar
    expire_in: 1 hour

# ----------------------------
# Build, tag et push des images Docker (tout dans un job pour éviter les conflits)
# ----------------------------
docker-build-and-push:
  stage: docker_build_push
  image: docker:24.0.2
  services:
    - docker:24.0.2-dind
  script:
    - echo "Construction des images Docker"
    - docker build -t $DOCKER_USER/service-client:latest ./service-client
    - docker build -t $DOCKER_USER/service-vehicules:latest ./service-vehicules
    - docker build -t $DOCKER_USER/service-reservation:latest ./service-reservation
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin
    - echo "Push des images Docker vers le registry"
    - docker push $DOCKER_USER/service-client:latest
    - docker push $DOCKER_USER/service-vehicules:latest
    - docker push $DOCKER_USER/service-reservation:latest

# ----------------------------
# Déploiement via docker-compose
# ----------------------------
deploy-all:
  stage: deploy
  image: docker:24.0.2
  services:
    - docker:24.0.2-dind
  script:
    - echo "Déploiement via docker-compose"
    - docker compose -f docker-compose.yml pull
    - docker compose -f docker-compose.yml up -d --remove-orphans
  only:
    - main
