image: docker:24.0.2

services:
  - docker:24.0.2-dind

stages:
  - build_and_test
  - deploy

variables:
  DOCKER_DRIVER: overlay2

# ----------------------------
# Build et test des microservices
# ----------------------------
service-client-build-test:
  stage: build_and_test
  script:
    - echo "Build et test du service client"
    - docker build -t service-client:latest ./service-client
    - docker run --rm service-client:latest mvn test

service-reservation-build-test:
  stage: build_and_test
  script:
    - echo "Build et test du service reservation"
    - docker build -t service-reservation:latest ./service-reservation
    - docker run --rm service-reservation:latest mvn test

service-vehicules-build-test:
  stage: build_and_test
  script:
    - echo "Build et test du service vehicules"
    - docker build -t service-vehicules:latest ./service-vehicules
    - docker run --rm service-vehicules:latest mvn test

# ----------------------------
# Déploiement (optionnel)
# ----------------------------
deploy-all:
  stage: deploy
  script:
    - echo "Déploiement des services..."
    # ici tu peux ajouter docker-compose, kubectl, ou autre
  when: manual
